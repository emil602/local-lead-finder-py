<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Lead Finder (Python MVP)</title>
  <style>
    :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --head:#f9fafb; --btn-bg:#111827; --btn-fg:#fff; --btn-muted-bg:#f3f4f6; --btn-muted-fg:#111827; --accent:#3b82f6; }
    body { background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Arial,sans-serif; margin:24px; }
    h1 { margin:0 0 16px; }
    input,button { padding:10px; font-size:16px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--fg); }
    input:focus,button:focus { outline:2px solid var(--accent); outline-offset:2px; }
    .row { display:flex; gap:8px; margin-bottom:12px; }
    .muted { color:var(--muted); font-size:12px; margin-top:8px; }
    .bar { display:flex; align-items:center; justify-content:space-between; margin-top:8px; gap:12px; }
    .btn { background:var(--btn-bg); color:var(--btn-fg); border:none; cursor:pointer; }
    .btn:disabled { opacity:.55; cursor:not-allowed; }
    .btn-muted { background:var(--btn-muted-bg); color:var(--btn-muted-fg); border:1px solid var(--border); }
    table { border-collapse:collapse; width:100%; margin-top:12px; }
    th,td { border:1px solid var(--border); padding:8px; text-align:left; font-size:14px; vertical-align:top; }
    thead { background:var(--head); }
  </style>
</head>
<body>
  <h1>Local Lead Finder (Python MVP)</h1>

  <form id="searchForm">
    <div class="row">
      <input id="category" placeholder='Category (e.g., "restaurants")' required />
      <input id="location" placeholder='Location (e.g., "Austin, TX")' required />
      <button id="searchBtn" type="submit" class="btn">Search</button>
    </div>
  </form>

  <div class="bar">
    <div id="status" class="muted">No results yet</div>
    <div>
      <button id="enrichBtn" class="btn-muted" disabled>Enrich</button>
      <button id="loadMoreBtn" class="btn-muted" disabled>Load More</button>
      <button id="downloadBtn" class="btn-muted" disabled>Download CSV</button>
    </div>
  </div>

  <div style="overflow:auto;">
    <table id="resultsTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Address</th>
          <th>Rating</th>
          <th>Reviews</th>
          <th>Phone</th>
          <th>Website</th>
          <th>Emails</th> <!-- NEW -->
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="muted">Data from Google Places. Subject to Google Maps Platform Terms; show appropriate attributions.</p>

  <script>
    const form = document.getElementById("searchForm");
    const categoryEl = document.getElementById("category");
    const locationEl = document.getElementById("location");
    const statusEl = document.getElementById("status");
    const tableBody = document.querySelector("#resultsTable tbody");
    const downloadBtn = document.getElementById("downloadBtn");
    const loadMoreBtn = document.getElementById("loadMoreBtn");
    const enrichBtn = document.getElementById("enrichBtn");
    const searchBtn = document.getElementById("searchBtn");

    var currentLeads = [];
    var currentCategory = "";
    var currentLocation = "";
    var nextPageToken = "";

    function val(x,d){ return (x===null||x===undefined)?d:x; }
    function appendRows(leads){
      for (var i=0;i<leads.length;i++){
        var l = leads[i];
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>"+val(l.name,"")+"</td>"+
          "<td>"+val(l.address,"")+"</td>"+
          "<td>"+val(l.rating,"-")+"</td>"+
          "<td>"+val(l.reviewCount,"-")+"</td>"+
          "<td>"+val(l.phone,"-")+"</td>"+
          "<td>"+(l.website?('<a href=\"'+l.website+'\" target=\"_blank\" rel=\"noreferrer\">Visit</a>'):"-")+"</td>"+
          "<td>"+(Array.isArray(l.emails)?l.emails.join(', '):(l.emails||''))+"</td>";
        tableBody.appendChild(tr);
      }
    }
    function rerender(){ tableBody.innerHTML=""; appendRows(currentLeads); }
    function updateUI(){
      statusEl.textContent = currentLeads.length?("Found "+currentLeads.length+" leads"):"No results";
      downloadBtn.disabled = currentLeads.length===0;
      loadMoreBtn.disabled = !nextPageToken;
      enrichBtn.disabled = currentLeads.length===0;
    }
    function fetchPage(opts){
      var body={};
      if (opts.initial){ body.category=currentCategory; body.location=currentLocation; }
      if (nextPageToken){ body.pageToken=nextPageToken; }
      return fetch("/api/search",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body)})
        .then(r=>r.json().then(j=>({ok:r.ok,body:j})))
        .then(res=>{
          if(!res.ok) throw new Error(res.body&&res.body.error?res.body.error:"Search failed");
          var newLeads=res.body.leads||[];
          currentLeads=currentLeads.concat(newLeads);
          nextPageToken=res.body.nextPageToken||"";
          rerender(); updateUI();
        });
    }
    form.addEventListener("submit",function(e){
      e.preventDefault();
      currentCategory=categoryEl.value.trim();
      currentLocation=locationEl.value.trim();
      currentLeads=[]; nextPageToken=""; tableBody.innerHTML="";
      statusEl.textContent="Searching…"; downloadBtn.disabled=true; loadMoreBtn.disabled=true; enrichBtn.disabled=true; searchBtn.disabled=true;
      fetchPage({initial:true}).catch(err=>statusEl.textContent="Error: "+err.message).finally(()=>{searchBtn.disabled=false;});
    });
    loadMoreBtn.addEventListener("click",function(){
      if(!nextPageToken) return;
      statusEl.textContent="Loading more…"; loadMoreBtn.disabled=true;
      fetchPage({initial:false}).catch(err=>statusEl.textContent="Error: "+err.message);
    });
    enrichBtn.addEventListener("click",function(){
      if(!currentLeads.length) return;
      statusEl.textContent="Enriching…"; enrichBtn.disabled=true;
      fetch("/api/enrich",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({leads:currentLeads})})
        .then(r=>r.json().then(j=>({ok:r.ok,body:j})))
        .then(res=>{
          if(!res.ok) throw new Error(res.body&&res.body.error?res.body.error:"Enrichment failed");
          var bySite={}; (res.body.enriched||[]).forEach(e=>{ if(e&&e.website) bySite[e.website]=e; });
          for (var i=0;i<currentLeads.length;i++){
            var site=currentLeads[i].website||"";
            if(site && bySite[site]){
              var info=bySite[site];
              currentLeads[i].meta_description = info.meta_description || currentLeads[i].meta_description;
              currentLeads[i].about_summary   = info.about_summary   || currentLeads[i].about_summary;
              currentLeads[i].contact_url     = info.contact_url     || currentLeads[i].contact_url;
              currentLeads[i].emails          = info.emails || currentLeads[i].emails;
            }
          }
          rerender(); statusEl.textContent="Enriched "+currentLeads.length+" leads";
        })
        .catch(err=>statusEl.textContent="Error: "+err.message)
        .finally(()=>{ enrichBtn.disabled = currentLeads.length===0; });
    });
    downloadBtn.addEventListener("click",function(){
      fetch("/api/export",{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify({leads:currentLeads})})
        .then(r=>r.blob()).then(blob=>{ var url=URL.createObjectURL(blob); var a=document.createElement("a"); a.href=url; a.download="leads_enriched.csv"; a.click(); URL.revokeObjectURL(url); })
        .catch(()=>alert("Failed to download CSV"));
    });
  </script>
</body>
</html>
